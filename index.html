<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MODULO PRENOTAZIONE LOCALIZZATORI</title>
<style>
  * {
    box-sizing: border-box;
  }
  
  body { 
    font-family: Roboto, Arial, sans-serif; 
    margin: 0; 
    padding: 0; 
    display: flex; 
    justify-content: center; 
    background: #e6f0fa; 
    font-size: 16px; 
  }
  
  #formWrapper { 
    width: 100%; 
    max-width: 480px; 
    padding: 10px 20px; 
    background: #fff; 
    border-radius: 12px; 
    box-shadow: 0 2px 12px rgba(0,0,0,0.1); 
    margin: 20px auto;
  }
  
  h2 {
    text-align: center; 
    font-size: 22px; 
    margin-bottom: 10px;
  }
  
  h4 {
    text-align: center; 
    font-size: 16px; 
    color: #555; 
    margin: 5px 0; 
    font-weight: normal;
  }
  
  label {
    display: block; 
    font-weight: bold; 
    margin-top: 18px; 
    font-size: 16px;
    text-align: center;
  }
  
  input, select, textarea {
    width: 100%; 
    padding: 16px 14px; 
    margin-top: 5px; 
    font-size: 20px; 
    line-height: 1.4; 
    border-radius: 8px; 
    border: 1px solid #ccc; 
    display: block;
    text-align: center;
  }
  
  select {
    padding: 12px 14px; 
    height: auto;
  }
  
  select option {
    text-align: left;
  }
  
  #compagnia, #lavorazione {
    text-align: left;
  }
  
  button {
    background-color: #1a73e8; 
    color: white; 
    border: none; 
    cursor: pointer; 
    margin-top: 15px; 
    font-size: 20px; 
    padding: 18px; 
    border-radius: 8px; 
    width: 100%;
    font-weight: bold;
    transition: all 0.3s ease;
  }
  
  button:hover:not(:disabled) {
    background: #1557b0;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(26,115,232,0.3);
  }
  
  button:disabled {
    background-color: #ccc; 
    cursor: not-allowed;
  }
  
  #alertObbligatorio {
    font-weight: bold; 
    margin-top: 5px; 
    color: red; 
    font-size: 16px;
    text-align: center;
  }
  
  #alertAnnullamento {
    display: none; 
    font-weight: bold; 
    margin-top: 10px; 
    color: red; 
    font-size: 15px; 
    text-align: center; 
    background: #ffe6e6; 
    padding: 12px; 
    border-radius: 8px; 
    border: 2px solid red;
  }
  
  #successOverlay, #errorOverlay {
    display: none; 
    position: fixed; 
    top: 50%; 
    left: 50%; 
    transform: translate(-50%, -50%); 
    background: rgba(255,255,255,0.98); 
    z-index: 100; 
    text-align: center; 
    padding: 40px 30px; 
    font-size: 18px; 
    font-weight: bold; 
    max-width: 90%; 
    border-radius: 12px; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    line-height: 1.6;
  }

  #successOverlay {
    color: #2e7d32;
    border: 3px solid #4caf50;
  }

  #errorOverlay {
    color: #c62828;
    border: 3px solid #f44336;
  }
  
  .campo-condizionale {
    display: none;
  }
  
  .avviso-importante {
    background: #fff3cd; 
    border: 2px solid #ffc107; 
    border-radius: 8px; 
    padding: 15px; 
    margin: 20px 0; 
    font-size: 14px; 
    line-height: 1.6; 
    color: #856404; 
    text-align: center;
  }
  
  .avviso-importante strong {
    display: block; 
    font-size: 16px; 
    margin-bottom: 8px; 
    color: #000; 
    font-weight: bold;
  }
  
  #loadingOverlay, #sendingOverlay {
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: #e6f0fa; 
    z-index: 200; 
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
    align-items: center;
  }

  #sendingOverlay {
    display: none;
  }
  
  .spinner {
    border: 8px solid #f3f3f3; 
    border-top: 8px solid #1a73e8; 
    border-radius: 50%; 
    width: 60px; 
    height: 60px; 
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); } 
    100% { transform: rotate(360deg); }
  }
  
  #loadingOverlay p, #sendingOverlay p {
    margin-top: 20px; 
    font-size: 18px; 
    color: #555; 
    font-weight: bold;
    text-align: center;
    padding: 0 20px;
  }
</style>
</head>
<body onload="init()">

<!-- Schermata di caricamento iniziale -->
<div id="loadingOverlay">
  <div class="spinner"></div>
  <p>Caricamento modulo in corso...</p>
</div>

<!-- Schermata invio dati -->
<div id="sendingOverlay">
  <div class="spinner"></div>
  <p>Invio dati in corso...<br>NON CHIUDERE LA PAGINA<br>Attendere...</p>
</div>

<div id="formWrapper" style="display:none;">
  <h2>PRENOTAZIONE APPUNTAMENTO LOCALIZZATORE SATELLITARE ASSICURATIVO o MOVE-IN</h2>
  <h4>PALAMINI AUTO, Via San Luigi 1/A, Cesano Maderno</h4>
  
  <form id="prenotaForm" oninput="aggiornaStatoPrenota(); return false;">
    <label>EMAIL:</label>
    <input type="email" id="email" inputmode="email" autocomplete="email" onchange="aggiornaStatoPrenota()">

    <label>TARGA AUTO:</label>
    <input type="text" id="targa" maxlength="7" onchange="aggiornaStatoPrenota()" style="text-transform:uppercase;">
  
    <label>NOME E COGNOME ASSICURATO:</label>
    <input type="text" id="nomeCognome" onchange="aggiornaStatoPrenota()">

    <label>CONTATTO TELEFONICO:</label>
    <input type="text" id="telefono" inputmode="tel" autocomplete="tel" onchange="aggiornaStatoPrenota()">

    <label>NOME COMPAGNIA ASSICURATIVA o PROVIDER MOVE-IN</label>
    <select id="compagnia" onchange="aggiornaStatoPrenota()">
      <option value="" disabled selected>Seleziona...</option>
    </select>

    <div class="avviso-importante">
      <strong>IMPORTANTE DA LEGGERE!</strong>
      Per gli smontaggi: munirsi TASSATIVAMENTE del foglio di installazione per conoscere la posizione del localizzatore all'interno dell'auto (NON serve se si conosce l'ESATTA posizione del localizzatore all'interno dell'auto).
      <br><br>ATTENZIONE: L'abitacolo e il baule del veicolo devono essere PULITI e PRIVI di oggetti personali.<br><br>
      NON prenotare tramite questo modulo la SOLA consegna o la riconsegna del localizzatore (ConTe, BeRebel), √® sufficiente passare in officina dal luned√¨ al venerd√¨ 9:00 - 12:15 e 14:30 - 17:30 per il ritiro senza appuntamento. Prenotare solo se si desidera la lavorazione di montaggio o smontaggio.
    </div>

    <label>LAVORAZIONE RICHIESTA</label>
    <select id="lavorazione" onchange="aggiornaVisibilita()">
      <option value="" selected disabled>Seleziona...</option>
      <option value="montaggio">MONTAGGIO (massimo 50 minuti di fermo auto)</option>
      <option value="smontaggio">SMONTAGGIO (massimo 50 minuti di fermo auto)</option>
      <option value="smontmont">SMONTAGGIO + MONTAGGIO (massimo 1,5 ora di fermo auto)</option>
      <option value="anomalia">ANOMALIA-GUASTO-VERIFICA LOCALIZZATORE (massimo 3 ore di fermo auto)</option>
      <option value="annullamento">ANNULLAMENTO APPUNTAMENTO</option>
    </select>

    <div id="alertAnnullamento">
      ‚ö†Ô∏è IMPORTANTE: Scrivere nel campo "note cliente" la data e l'ora dell'appuntamento che si vuole cancellare
    </div>

    <label>EVENTUALI NOTE CLIENTE:</label>
    <input type="text" id="notecliente" onchange="aggiornaStatoPrenota()">
    
    <div id="wrapperData" class="campo-condizionale">
      <label>DATA APPUNTAMENTO:</label>
      <select id="dataAppuntamento" onchange="aggiornaStatoPrenota()">
        <option value="" selected disabled>Seleziona...</option>
      </select>
    </div>
    
    <div style="background:#ffe6e6; border:2px solid red; border-radius:8px; padding:12px; margin-top:15px; color:red; font-weight:bold; font-size:15px; text-align:center;">
      ‚è∞ Si raccomanda di rispettare l'orario prescelto. Con un ritardo superiore ai 10 minuti l'appuntamento verr√† considerato annullato.
    </div>
    
    <button type="button" id="prenota" onclick="invia()" disabled>Prenota</button>
    <div id="alertObbligatorio">‚ùå Attenzione: tutti i campi sono obbligatori</div>
  </form>
</div>

<div id="successOverlay">
  ‚úÖ MODULO INVIATO CORRETTAMENTE<br><br>
  Si ricorda che √® obbligatorio presentarsi in officina il giorno dell'appuntamento con la mail appena ricevuta (controllare anche lo SPAM).<br><br>
  Grazie.
</div>

<div id="errorOverlay">
  ‚ùå ERRORE NELL'INVIO DEI DATI<br><br>
  Si √® verificato un problema durante l'invio della prenotazione.<br><br>
  Ti preghiamo di riprovare o contattarci telefonicamente.
</div>

<script>
// ========================================
// DATABASE COMPAGNIE ASSICURATIVE
// ========================================
const COMPAGNIE = [
  "Unipol",
  "Linear",
  "Arca",
  "BeRebel (costo a carico cliente di 18,30‚Ç¨)",
  "MoveIN-Viasat (prendere appuntamento 7gg dopo il pagamento a Viasat)",
  "MoveIN-Octo Telematics",
  "MoveIN-Unipol (prendere appuntamento tra almeno 10gg)",
  "Groupama",
  "Generali (prendere appuntamento 7gg dopo emissione polizza)",
  "Genertel-Jeniot (prendere appuntamento 7gg dopo emissione polizza)",
  "Cattolica (prendere appuntamento 7gg dopo emissione polizza)",
  "Tua Assicurazioni",
  "IntesaSanPaolo",
  "Allianz",
  "ConTe-Octo Telematics (costo a carico cliente di 12,20‚Ç¨)",
  "Sara Assicurazioni",
  "Italiana Assicurazioni",
  "ALTRO: Inserire nome compagnia assicurativa nel campo NOTE CLIENTE"
];

// ========================================
// CONFIGURAZIONE API
// ========================================
const API_URL = 'https://script.google.com/macros/s/AKfycbwoC5ZEaTAGQru63oUO8DyD0Y20bP5hblqtjFG8CWjudmPM5TfcFZsExi6rs4qyeEsR/exec';

let dateDisponibiliMontaggio = [];
let dateDisponibiliAnomalia = [];

// ========================================
// INIZIALIZZAZIONE
// ========================================
async function init() {
  const loadingScreen = document.getElementById('loadingOverlay');
  const formWrapper = document.getElementById('formWrapper');

  console.log('üîÑ Caricamento dati in corso...');

  // Popola dropdown compagnie
  const selectCompagnia = document.getElementById("compagnia");
  COMPAGNIE.forEach(c => {
    const option = document.createElement("option");
    option.value = c;
    option.textContent = c;
    selectCompagnia.appendChild(option);
  });

  // Carica date disponibili
  try {
    const response = await fetch(API_URL + '?action=getAllData');
    const data = await response.json();

    console.log('‚úÖ Dati ricevuti:', data);

    if (data.error) throw new Error(data.error);

    dateDisponibiliMontaggio = data.dateMontaggio || [];
    dateDisponibiliAnomalia = data.dateAnomalia || [];
    
    console.log('üìÖ Date montaggio:', dateDisponibiliMontaggio.length);
    console.log('üìÖ Date anomalia:', dateDisponibiliAnomalia.length);

    loadingScreen.style.display = 'none';
    formWrapper.style.display = 'block';

  } catch (error) {
    console.error('‚ùå Errore caricamento:', error);
    alert('Errore nel caricamento delle date. Riprova pi√π tardi.');
    loadingScreen.querySelector('p').textContent = 'Errore di caricamento. Ricarica la pagina.';
  }
}

// ========================================
// GESTIONE VISIBILIT√Ä CAMPI
// ========================================
function aggiornaVisibilita() {
  const lavorazione = document.getElementById("lavorazione").value;
  const wrapperData = document.getElementById("wrapperData");
  const selectData = document.getElementById("dataAppuntamento");
  const alertAnnullamento = document.getElementById("alertAnnullamento");
  
  if (lavorazione === "annullamento") {
    alertAnnullamento.style.display = "block";
  } else {
    alertAnnullamento.style.display = "none";
  }
  
  const richiedeData = ["montaggio", "smontaggio", "smontmont", "anomalia"].includes(lavorazione);
  
  if (richiedeData) {
    wrapperData.style.display = "block";
    
    selectData.innerHTML = '<option value="" selected disabled>Seleziona...</option>';
    
    const dateArray = lavorazione === "anomalia" ? dateDisponibiliAnomalia : dateDisponibiliMontaggio;
    
    dateArray.forEach(d => {
      const option = document.createElement("option");
      option.value = d;
      option.textContent = d;
      selectData.appendChild(option);
    });
  } else {
    wrapperData.style.display = "none";
    selectData.value = "";
  }
  
  aggiornaStatoPrenota();
}

// ========================================
// VALIDAZIONE FORM
// ========================================
function aggiornaStatoPrenota() {
  const btn = document.getElementById("prenota");
  const lavorazione = document.getElementById("lavorazione").value;
  const richiedeData = ["montaggio", "smontaggio", "smontmont", "anomalia"].includes(lavorazione);
  
  const campiBase = ["email", "targa", "nomeCognome", "telefono", "compagnia"].every(
    id => document.getElementById(id).value.trim() !== ""
  );
  
  const lavorazioneValida = lavorazione !== "";
  const dataValida = !richiedeData || document.getElementById("dataAppuntamento").value !== "";
  const noteValide = lavorazione !== "annullamento" || document.getElementById("notecliente").value.trim() !== "";
  
  const tuttiCampiOk = campiBase && lavorazioneValida && dataValida && noteValide;
  
  btn.disabled = !tuttiCampiOk;
  document.getElementById("alertObbligatorio").style.display = tuttiCampiOk ? "none" : "block";
}

// ========================================
// INVIO DATI
// ========================================
async function invia() {
  const btn = document.getElementById("prenota");
  btn.disabled = true;
  
  document.getElementById("sendingOverlay").style.display = "flex";

  const dati = {
    email: document.getElementById("email").value.trim(),
    targa: document.getElementById("targa").value.trim().toUpperCase(),
    nomeCognome: document.getElementById("nomeCognome").value.trim(),
    telefono: document.getElementById("telefono").value.trim(),
    compagnia: document.getElementById("compagnia").value,
    lavorazione: document.getElementById("lavorazione").value,
    notecliente: document.getElementById("notecliente").value.trim(),
    dataAppuntamento: document.getElementById("dataAppuntamento").value
  };

  console.log('üì§ Invio dati:', dati);

  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'salvaPrenotazione', dati: dati })
    });

    console.log('üì• Response status:', response.status);
    
    const result = await response.json();

    console.log('üìã Risultato:', result);

    document.getElementById("sendingOverlay").style.display = "none";

    if (result.success) {
      console.log('‚úÖ Prenotazione confermata');
      document.getElementById("formWrapper").style.display = "none";
      const overlay = document.getElementById("successOverlay");
      overlay.style.display = "block";
      overlay.scrollIntoView({behavior:"smooth", block:"center"});
    } else {
      console.error('‚ùå Errore server:', result.error);
      const errorOverlay = document.getElementById("errorOverlay");
      errorOverlay.style.display = "block";
      errorOverlay.scrollIntoView({behavior:"smooth", block:"center"});
      btn.disabled = false;
    }
  } catch(error) {
    console.error('‚ùå Errore fetch:', error);
    document.getElementById("sendingOverlay").style.display = "none";
    const errorOverlay = document.getElementById("errorOverlay");
    errorOverlay.style.display = "block";
    errorOverlay.scrollIntoView({behavior:"smooth", block:"center"});
    btn.disabled = false;
  }
}
</script>
</body>
</html>
